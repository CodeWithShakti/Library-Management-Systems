
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .hidden { display: none; }
        .nav-item:hover { background-color: #4f46e5; transition: background-color 0.3s ease; }
        .active-link { background-color: #2563eb; }
        .hero { background: linear-gradient(135deg, #6366f1, #9333ea); color: white; padding: 50px; border-radius: 20px; text-align: center; animation: fadeIn 0.5s ease-in; }
        .hero-user { background: linear-gradient(135deg, #06b6d4, #3b82f6); color: white; padding: 50px; border-radius: 20px; text-align: center; animation: fadeIn 0.5s ease-in; }
        .card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; border-radius: 5px; color: white; z-index: 1000; animation: slideIn 0.5s ease, slideOut 0.5s ease 2s forwards; }
        .toast-success { background-color: #10b981; }
        .toast-error { background-color: #ef4444; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; }
        .dark-mode { background-color: #1f2937; color: #e5e7eb; }
        .dark-mode .bg-white { background-color: #374151; }
        .dark-mode .bg-gray-100 { background-color: #111827; }
        .dark-mode .bg-gray-200 { background-color: #4b5563; }
        .dark-mode .text-gray-900 { color: #e5e7eb; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 font-sans transition-colors duration-300">
    <div id="app" class="min-h-screen flex flex-col">
        <!-- LOGIN PAGE -->
        <div id="loginPage" class="flex justify-center items-center h-screen">
            <div class="w-full max-w-md p-8 bg-white rounded-lg shadow-lg animate-fadeIn">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-900">Library Login</h2>
                <input id="username" type="text" placeholder="Username" class="w-full p-2 mb-4 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input id="password" type="password" placeholder="Password" class="w-full p-2 mb-4 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="login()" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition-colors duration-200 flex justify-center items-center">
                    <span id="loginBtnText">Login</span>
                    <span id="loginSpinner" class="spinner hidden ml-2"></span>
                </button>
                <p id="loginError" class="text-red-500 mt-2 text-center hidden">Invalid credentials!</p>
            </div>
        </div>

        <!-- DASHBOARD -->
        <div id="dashboard" class="hidden flex flex-col min-h-screen">
            <!-- NAVBAR -->
            <nav class="bg-indigo-600 text-white px-6 py-4 flex justify-between items-center flex-wrap shadow-md">
                <div class="text-xl font-bold">Library System</div>
                <div class="flex gap-2 items-center flex-wrap">
                    <div id="navLinks" class="flex gap-2 flex-wrap"></div>
                    <button onclick="toggleDarkMode()" class="p-2 rounded hover:bg-indigo-500 transition-colors duration-200">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </nav>

            <!-- MAIN CONTENT -->
            <div id="mainContent" class="flex-1 p-5">
                <!-- ADMIN HOME -->
                <div id="adminHome" class="hidden hero">
                    <h1 class="text-3xl font-bold mb-4">Welcome Admin</h1>
                    <p class="mb-4">Manage books, members, transactions, and generate reports from here.</p>
                    <div class="flex justify-center gap-4 mb-4">
                        <button onclick="showSection('bookSection')" class="bg-white text-indigo-600 px-4 py-2 rounded shadow hover:bg-gray-100 transition-colors duration-200">Manage Books</button>
                        <button onclick="showSection('reportSection')" class="bg-white text-indigo-600 px-4 py-2 rounded shadow hover:bg-gray-100 transition-colors duration-200">View Reports</button>
                    </div>
                    <div class="flex justify-center gap-4 text-2xl">
                        <i class="fab fa-facebook hover:text-gray-200 cursor-pointer transition-colors duration-200"></i>
                        <i class="fab fa-twitter hover:text-gray-200 cursor-pointer transition-colors duration-200"></i>
                        <i class="fab fa-linkedin hover:text-gray-200 cursor-pointer transition-colors duration-200"></i>
                    </div>
                </div>

                <!-- USER HOME -->
                <div id="userHome" class="hidden hero-user">
                    <h1 class="text-3xl font-bold mb-4">Welcome User</h1>
                    <p class="mb-4">Search books, issue or return items, and manage your profile from here.</p>
                    <div class="flex justify-center gap-4 mb-4">
                        <button onclick="showSection('bookSection')" class="bg-white text-blue-600 px-4 py-2 rounded shadow hover:bg-gray-100 transition-colors duration-200">Search Books</button>
                        <button onclick="showSection('transactionSection')" class="bg-white text-blue-600 px-4 py-2 rounded shadow hover:bg-gray-100 transition-colors duration-200">My Transactions</button>
                    </div>
                    <div class="flex justify-center gap-4 text-2xl">
                        <i class="fab fa-instagram hover:text-gray-200 cursor-pointer transition-colors duration-200"></i>
                        <i class="fab fa-whatsapp hover:text-gray-200 cursor-pointer transition-colors duration-200"></i>
                        <i class="fab fa-github hover:text-gray-200 cursor-pointer transition-colors duration-200"></i>
                    </div>
                </div>

                <!-- BOOKS -->
                <div id="bookSection" class="hidden bg-white p-5 rounded-lg shadow-lg mt-4 animate-fadeIn">
                    <h3 class="text-xl font-bold mb-4 text-gray-900">Books & Movies</h3>
                    <div class="mb-4">
                        <input id="bookSearch" type="text" placeholder="Search Books/Movies..." class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="searchBooks()">
                    </div>
                    <div id="adminBookForm" class="mb-4 flex flex-wrap gap-2">
                        <input id="bookName" type="text" placeholder="Book/Movie Name" class="border p-2 rounded flex-1 min-w-[150px]">
                        <input id="bookAuthor" type="text" placeholder="Author/Director" class="border p-2 rounded flex-1 min-w-[150px]">
                        <select id="bookType" class="border p-2 rounded min-w-[100px]">
                            <option value="book">Book</option>
                            <option value="movie">Movie</option>
                        </select>
                        <button onclick="addBook()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors duration-200 flex items-center">
                            <span>Add</span>
                            <span id="addBookSpinner" class="spinner hidden ml-2"></span>
                        </button>
                    </div>
                    <div id="bookList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>

                <!-- MEMBERS -->
                <div id="memberSection" class="hidden bg-white p-5 rounded-lg shadow-lg mt-4 animate-fadeIn">
                    <h3 class="text-xl font-bold mb-4 text-gray-900">Manage Members</h3>
                    <div id="adminMemberForm" class="mb-4 flex flex-wrap gap-2">
                        <input id="memberName" type="text" placeholder="Member Name" class="border p-2 rounded flex-1 min-w-[150px]">
                        <input id="memberUsername" type="text" placeholder="Username" class="border p-2 rounded flex-1 min-w-[150px]">
                        <button onclick="addMember()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors duration-200 flex items-center">
                            <span>Add Member</span>
                            <span id="addMemberSpinner" class="spinner hidden ml-2"></span>
                        </button>
                    </div>
                    <div id="memberList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>

                <!-- TRANSACTIONS -->
                <div id="transactionSection" class="hidden bg-white p-5 rounded-lg shadow-lg mt-4 animate-fadeIn">
                    <h3 class="text-xl font-bold mb-4 text-gray-900">Transactions</h3>
                    <div id="adminTranForm" class="mb-4 flex flex-wrap gap-2">
                        <select id="tranMember" class="border p-2 rounded flex-1 min-w-[150px]"></select>
                        <select id="tranBook" class="border p-2 rounded flex-1 min-w-[150px]"></select>
                        <button onclick="issueBook()" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 transition-colors duration-200 flex items-center">
                            <span>Issue</span>
                            <span id="issueSpinner" class="spinner hidden ml-2"></span>
                        </button>
                    </div>
                    <table class="table-auto w-full mt-4 border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="border px-2 py-1 text-gray-900">Member</th>
                                <th class="border px-2 py-1 text-gray-900">Item</th>
                                <th class="border px-2 py-1 text-gray-900">Status</th>
                                <th class="border px-2 py-1 text-gray-900">Action</th>
                            </tr>
                        </thead>
                        <tbody id="tranList"></tbody>
                    </table>
                </div>

                <!-- REPORTS -->
                <div id="reportSection" class="hidden bg-white p-5 rounded-lg shadow-lg mt-4 animate-fadeIn">
                    <h3 class="text-xl font-bold mb-4 text-gray-900">Reports</h3>
                    <ul class="space-y-2">
                        <li class="text-gray-900">Total Books/Movies: <span id="totalBooks" class="font-semibold">0</span></li>
                        <li class="text-gray-900">Total Members: <span id="totalMembers" class="font-semibold">0</span></li>
                        <li class="text-gray-900">Issued Items: <span id="totalIssued" class="font-semibold">0</span></li>
                        <li class="text-gray-900">Overdue Items: <span id="totalOverdue" class="font-semibold">0</span></li>
                    </ul>
                </div>

                <!-- USER PROFILE -->
                <div id="profileSection" class="hidden bg-white p-5 rounded-lg shadow-lg mt-4 animate-fadeIn">
                    <h3 class="text-xl font-bold mb-4 text-gray-900">User Profile</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-900">Username</label>
                            <input id="profileUsername" type="text" class="w-full p-2 border rounded bg-gray-100" readonly>
                        </div>
                        <div>
                            <label class="block text-gray-900">Name</label>
                            <input id="profileName" type="text" class="w-full p-2 border rounded">
                        </div>
                        <button onclick="updateProfile()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors duration-200 flex items-center">
                            <span>Update Profile</span>
                            <span id="profileSpinner" class="spinner hidden ml-2"></span>
                        </button>
                    </div>
                </div>

                <!-- PAY FINE -->
                <div id="payFineSection" class="hidden bg-white p-5 rounded-lg shadow-lg mt-4 animate-fadeIn">
                    <h3 class="text-xl font-bold mb-4 text-gray-900">Pay Fine</h3>
                    <div class="space-y-4">
                        <!-- Payment Method Toggle -->
                        <div class="flex gap-4">
                            <label class="flex items-center">
                                <input type="radio" name="paymentMethod" value="online" class="mr-2" checked onclick="togglePaymentForm()">
                                <span class="text-gray-900">Online Payment</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="paymentMethod" value="offline" class="mr-2" onclick="togglePaymentForm()">
                                <span class="text-gray-900">Offline Payment</span>
                            </label>
                        </div>

                        <!-- Payment Form -->
                        <div id="paymentForm" class="space-y-4">
                            <div>
                                <label class="block text-gray-900">Amount</label>
                                <input id="fineAmount" type="number" placeholder="Enter fine amount" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <!-- Online Payment Fields -->
                            <div id="onlinePaymentFields" class="space-y-4">
                                <div>
                                    <label class="block text-gray-900">Card Number</label>
                                    <input id="cardNumber" type="text" placeholder="1234 5678 9012 3456" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div class="flex gap-4">
                                    <div class="flex-1">
                                        <label class="block text-gray-900">Expiry Date</label>
                                        <input id="cardExpiry" type="text" placeholder="MM/YY" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div class="flex-1">
                                        <label class="block text-gray-900">CVV</label>
                                        <input id="cardCVV" type="text" placeholder="123" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                            </div>

                            <!-- Offline Payment Fields -->
                            <div id="offlinePaymentFields" class="hidden space-y-4">
                                <div>
                                    <label class="block text-gray-900">Receipt Number</label>
                                    <input id="receiptNumber" type="text" placeholder="Enter receipt number" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-gray-900">Payment Date</label>
                                    <input id="paymentDate" type="date" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>

                            <button onclick="payFine()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors duration-200 flex items-center">
                                <span id="payBtnText">Pay</span>
                                <span id="fineSpinner" class="spinner hidden ml-2"></span>
                            </button>
                            <p id="fineMsg" class="mt-3 text-green-600 hidden">Fine Paid Successfully âœ…</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // USERS
            let users = [
                { username: "admin", password: "admin123", role: "admin", name: "Admin User" },
                { username: "user1", password: "user123", role: "user", name: "John Doe" }
            ];
            let currentUser = null;

            // DATA
            let members = [{ name: "John Doe", username: "user1", status: "active" }];
            let items = [
                { name: "Harry Potter", author: "J.K. Rowling", type: "book", status: "available" },
                { name: "Inception", author: "Christopher Nolan", type: "movie", status: "available" },
                { name: "Lord of the Rings", author: "J.R.R. Tolkien", type: "book", status: "available" },
                { name: "The Dark Knight", author: "Christopher Nolan", type: "movie", status: "available" },
                { name: "To Kill a Mockingbird", author: "Harper Lee", type: "book", status: "available" },
                { name: "Avengers: Endgame", author: "Marvel", type: "movie", status: "available" },
                { name: "1984", author: "George Orwell", type: "book", status: "available" },
                { name: "Titanic", author: "James Cameron", type: "movie", status: "available" },
                { name: "Moby Dick", author: "Herman Melville", type: "book", status: "available" },
                { name: "Gladiator", author: "Ridley Scott", type: "movie", status: "available" },
                { name: "Pride and Prejudice", author: "Jane Austen", type: "book", status: "available" },
                { name: "Avatar", author: "James Cameron", type: "movie", status: "available" },
                { name: "The Alchemist", author: "Paulo Coelho", type: "book", status: "available" },
                { name: "Shutter Island", author: "Martin Scorsese", type: "movie", status: "available" },
                { name: "Hamlet", author: "Shakespeare", type: "book", status: "available" },
                { name: "The Matrix", author: "Wachowskis", type: "movie", status: "available" },
                { name: "Sherlock Holmes", author: "Arthur Conan Doyle", type: "book", status: "available" },
                { name: "Interstellar", author: "Christopher Nolan", type: "movie", status: "available" },
                { name: "War and Peace", author: "Leo Tolstoy", type: "book", status: "available" },
                { name: "The Godfather", author: "Francis Ford Coppola", type: "movie", status: "available" }
            ];
            let transactions = [];

            // NAVBAR ITEMS
            const adminNav = [
                { name: "Home", section: "adminHome" },
                { name: "Books", section: "bookSection" },
                { name: "Members", section: "memberSection" },
                { name: "Transactions", section: "transactionSection" },
                { name: "Reports", section: "reportSection" },
                { name: "Logout", action: "logout" }
            ];
            const userNav = [
                { name: "Home", section: "userHome" },
                { name: "Books", section: "bookSection" },
                { name: "Transactions", section: "transactionSection" },
                { name: "Profile", section: "profileSection" },
                { name: "Pay Fine", section: "payFineSection" },
                { name: "Logout", action: "logout" }
            ];

            // UTILITY: SHOW TOAST
            function showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.innerText = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            // LOGIN
            async function login() {
                const btnText = document.getElementById("loginBtnText");
                const spinner = document.getElementById("loginSpinner");
                btnText.classList.add("hidden");
                spinner.classList.remove("hidden");
                await new Promise(resolve => setTimeout(resolve, 500)); // Simulate async
                const u = document.getElementById("username").value.trim();
                const p = document.getElementById("password").value.trim();
                let user = users.find(x => x.username === u && x.password === p);
                if (user) {
                    currentUser = user;
                    document.getElementById("loginPage").classList.add("hidden");
                    document.getElementById("dashboard").classList.remove("hidden");
                    document.getElementById("loginError").classList.add("hidden");
                    setupNavbar();
                    refresh();
                    showSection(user.role === "admin" ? "adminHome" : "userHome");
                    showToast("Login successful!", "success");
                } else {
                    document.getElementById("loginError").classList.remove("hidden");
                    showToast("Invalid credentials!", "error");
                }
                btnText.classList.remove("hidden");
                spinner.classList.add("hidden");
            }

            // LOGOUT
            function logout() {
                if (confirm("Are you sure to logout?")) {
                    currentUser = null;
                    document.getElementById("dashboard").classList.add("hidden");
                    document.getElementById("loginPage").classList.remove("hidden");
                    document.getElementById("username").value = "";
                    document.getElementById("password").value = "";
                    showToast("Logged out successfully!", "success");
                    document.body.classList.remove("dark-mode");
                }
            }

            // DARK MODE TOGGLE
            function toggleDarkMode() {
                document.body.classList.toggle("dark-mode");
                const icon = document.querySelector("nav .fa-moon");
                icon.classList.toggle("fa-sun");
                icon.classList.toggle("fa-moon");
            }

            // NAVBAR SETUP
            function setupNavbar() {
                const nav = document.getElementById("navLinks");
                nav.innerHTML = "";
                const navItems = currentUser.role === "admin" ? adminNav : userNav;
                navItems.forEach(item => {
                    const span = document.createElement("span");
                    span.className = "nav-item px-3 py-1 rounded cursor-pointer text-white transition-colors duration-200";
                    span.innerText = item.name;
                    if (item.action === "logout") span.onclick = logout;
                    else span.onclick = () => { showSection(item.section); setActiveNav(item.name); };
                    nav.appendChild(span);
                });
                document.getElementById("adminBookForm").style.display = currentUser.role === "admin" ? "flex" : "none";
                document.getElementById("adminMemberForm").style.display = currentUser.role === "admin" ? "flex" : "none";
                document.getElementById("adminTranForm").style.display = currentUser.role === "admin" ? "flex" : "none";
            }

            // SET ACTIVE NAV
            function setActiveNav(name) {
                document.querySelectorAll(".nav-item").forEach(item => {
                    item.classList.remove("active-link");
                    if (item.innerText === name) item.classList.add("active-link");
                });
            }

            // SHOW SECTION
            function showSection(id) {
                const sections = ["adminHome", "userHome", "bookSection", "memberSection", "transactionSection", "reportSection", "profileSection", "payFineSection"];
                sections.forEach(s => document.getElementById(s).classList.add("hidden"));
                document.getElementById(id).classList.remove("hidden");
                if (id === "payFineSection") togglePaymentForm(); // Reset payment form
            }

            // SEARCH BOOKS
            function searchBooks() {
                const query = document.getElementById("bookSearch").value.trim().toLowerCase();
                const filtered = items.filter(b => b.name.toLowerCase().includes(query) || b.author.toLowerCase().includes(query));
                renderBooks(filtered);
            }

            // RENDER BOOKS
            function renderBooks(bookList = items) {
                document.getElementById("bookList").innerHTML = bookList.map((b, i) => `
                    <div class="card bg-gray-50 p-4 rounded-lg shadow-md">
                        <h4 class="text-lg font-semibold text-gray-900">${b.name}</h4>
                        <p class="text-gray-600">By ${b.author}</p>
                        <p class="text-gray-600">Type: ${b.type}</p>
                        <p class="text-${b.status === 'available' ? 'green' : 'red'}-600">Status: ${b.status}</p>
                        ${currentUser.role === "admin" && b.status === "available" ? 
                            `<button onclick="deleteItem(${i})" class="mt-2 bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors duration-200">Delete</button>` : ""}
                    </div>
                `).join("");
            }

            // BOOKS
            async function addBook() {
                const btnText = document.getElementById("addBookSpinner").previousElementSibling;
                const spinner = document.getElementById("addBookSpinner");
                btnText.classList.add("hidden");
                spinner.classList.remove("hidden");
                await new Promise(resolve => setTimeout(resolve, 500)); // Simulate async
                const name = document.getElementById("bookName").value.trim();
                const author = document.getElementById("bookAuthor").value.trim();
                const type = document.getElementById("bookType").value;
                if (name && author) {
                    items.push({ name, author, type, status: "available" });
                    document.getElementById("bookName").value = "";
                    document.getElementById("bookAuthor").value = "";
                    refresh();
                    showToast("Book added successfully!", "success");
                } else {
                    showToast("Please fill all fields!", "error");
                }
                btnText.classList.remove("hidden");
                spinner.classList.add("hidden");
            }

            function deleteItem(i) {
                if (confirm("Delete this item?")) {
                    items.splice(i, 1);
                    refresh();
                    showToast("Item deleted!", "success");
                }
            }

            // MEMBERS
            async function addMember() {
                const btnText = document.getElementById("addMemberSpinner").previousElementSibling;
                const spinner = document.getElementById("addMemberSpinner");
                btnText.classList.add("hidden");
                spinner.classList.remove("hidden");
                await new Promise(resolve => setTimeout(resolve, 500)); // Simulate async
                const name = document.getElementById("memberName").value.trim();
                const username = document.getElementById("memberUsername").value.trim();
                if (name && username && !users.find(u => u.username === username)) {
                    members.push({ name, username, status: "active" });
                    users.push({ username, password: "12345", role: "user", name });
                    document.getElementById("memberName").value = "";
                    document.getElementById("memberUsername").value = "";
                    refresh();
                    showToast("Member added successfully!", "success");
                } else {
                    showToast("Username already exists or fields are empty!", "error");
                }
                btnText.classList.remove("hidden");
                spinner.classList.add("hidden");
            }

            function cancelMember(i) {
                if (confirm("Cancel membership?")) {
                    members[i].status = "inactive";
                    refresh();
                    showToast("Membership cancelled!", "success");
                }
            }

            // RENDER MEMBERS
            function renderMembers() {
                document.getElementById("memberList").innerHTML = members.map((m, i) => `
                    <div class="card bg-gray-50 p-4 rounded-lg shadow-md">
                        <h4 class="text-lg font-semibold text-gray-900">${m.name}</h4>
                        <p class="text-gray-600">Username: ${m.username}</p>
                        <p class="text-${m.status === 'active' ? 'green' : 'red'}-600">Status: ${m.status}</p>
                        ${currentUser.role === "admin" ? 
                            `<button onclick="cancelMember(${i})" class="mt-2 bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors duration-200">Cancel</button>` : ""}
                    </div>
                `).join("");
            }

            // TRANSACTIONS
            async function issueBook() {
                const btnText = document.getElementById("issueSpinner").previousElementSibling;
                const spinner = document.getElementById("issueSpinner");
                btnText.classList.add("hidden");
                spinner.classList.remove("hidden");
                await new Promise(resolve => setTimeout(resolve, 500)); // Simulate async
                const member = document.getElementById("tranMember").value;
                const book = document.getElementById("tranBook").value;
                if (member && book) {
                    let b = items.find(x => x.name.toLowerCase() === book.toLowerCase() && x.status === "available");
                    if (b) {
                        transactions.push({ member, book: b.name, status: "issued", date: new Date() });
                        b.status = "issued";
                        refresh();
                        showToast("Book issued successfully!", "success");
                    } else {
                        showToast("Book not available!", "error");
                    }
                } else {
                    showToast("Please select member and book!", "error");
                }
                btnText.classList.remove("hidden");
                spinner.classList.add("hidden");
            }

            function returnItem(i) {
                if (confirm("Return this item?")) {
                    let t = transactions[i];
                    t.status = "returned";
                    let b = items.find(b => b.name === t.book);
                    if (b) b.status = "available";
                    refresh();
                    showToast("Item returned successfully!", "success");
                }
            }

            // USER PROFILE
            async function updateProfile() {
                const btnText = document.getElementById("profileSpinner").previousElementSibling;
                const spinner = document.getElementById("profileSpinner");
                btnText.classList.add("hidden");
                spinner.classList.remove("hidden");
                await new Promise(resolve => setTimeout(resolve, 500)); // Simulate async
                const name = document.getElementById("profileName").value.trim();
                if (name) {
                    const user = users.find(u => u.username === currentUser.username);
                    user.name = name;
                    if (currentUser.role !== "admin") {
                        const member = members.find(m => m.username === currentUser.username);
                        if (member) member.name = name;
                    }
                    refresh();
                    showToast("Profile updated successfully!", "success");
                } else {
                    showToast("Name cannot be empty!", "error");
                }
                btnText.classList.remove("hidden");
                spinner.classList.add("hidden");
            }

            // TOGGLE PAYMENT FORM
            function togglePaymentForm() {
                const method = document.querySelector('input[name="paymentMethod"]:checked').value;
                document.getElementById("onlinePaymentFields").classList.toggle("hidden", method !== "online");
                document.getElementById("offlinePaymentFields").classList.toggle("hidden", method !== "offline");
            }

            // PAY FINE
            async function payFine() {
                const btnText = document.getElementById("payBtnText");
                const spinner = document.getElementById("fineSpinner");
                btnText.classList.add("hidden");
                spinner.classList.remove("hidden");
                await new Promise(resolve => setTimeout(resolve, 500)); // Simulate async
                const amount = document.getElementById("fineAmount").value.trim();
                const method = document.querySelector('input[name="paymentMethod"]:checked').value;
                let isValid = true;
                let errorMessage = "";

                // Validate amount
                if (!amount || amount <= 0) {
                    isValid = false;
                    errorMessage = "Please enter a valid amount!";
                }

                // Validate online payment fields
                if (method === "online") {
                    const cardNumber = document.getElementById("cardNumber").value.trim();
                    const cardExpiry = document.getElementById("cardExpiry").value.trim();
                    const cardCVV = document.getElementById("cardCVV").value.trim();
                    if (!cardNumber || cardNumber.length < 12) {
                        isValid = false;
                        errorMessage = "Please enter a valid card number!";
                    } else if (!cardExpiry || !/^\d{2}\/\d{2}$/.test(cardExpiry)) {
                        isValid = false;
                        errorMessage = "Please enter a valid expiry date (MM/YY)!";
                    } else if (!cardCVV || cardCVV.length < 3) {
                        isValid = false;
                        errorMessage = "Please enter a valid CVV!";
                    }
                }

                // Validate offline payment fields
                if (method === "offline") {
                    const receiptNumber = document.getElementById("receiptNumber").value.trim();
                    const paymentDate = document.getElementById("paymentDate").value;
                    if (!receiptNumber) {
                        isValid = false;
                        errorMessage = "Please enter a valid receipt number!";
                    } else if (!paymentDate) {
                        isValid = false;
                        errorMessage = "Please select a payment date!";
                    }
                }

                if (isValid) {
                    document.getElementById("fineMsg").classList.remove("hidden");
                    document.getElementById("fineAmount").value = "";
                    document.getElementById("cardNumber").value = "";
                    document.getElementById("cardExpiry").value = "";
                    document.getElementById("cardCVV").value = "";
                    document.getElementById("receiptNumber").value = "";
                    document.getElementById("paymentDate").value = "";
                    setTimeout(() => document.getElementById("fineMsg").classList.add("hidden"), 2000);
                    showToast(`Fine paid successfully via ${method}!`, "success");
                } else {
                    showToast(errorMessage, "error");
                }

                btnText.classList.remove("hidden");
                spinner.classList.add("hidden");
            }

            // REFRESH DASHBOARD
            function refresh() {
                renderBooks();
                renderMembers();
                document.getElementById("tranList").innerHTML = transactions.map((t, i) => `
                    <tr>
                        <td class="border px-2 py-1 text-gray-900">${t.member}</td>
                        <td class="border px-2 py-1 text-gray-900">${t.book}</td>
                        <td class="border px-2 py-1 text-gray-900">${t.status}</td>
                        <td class="border px-2 py-1">
                            ${t.status === "issued" && currentUser.role === "admin" ? 
                                `<button onclick="returnItem(${i})" class="bg-green-500 text-white px-2 rounded hover:bg-green-600 transition-colors duration-200">Return</button>` : ""}
                        </td>
                    </tr>
                `).join("");
                document.getElementById("tranMember").innerHTML = members
                    .filter(m => m.status === "active")
                    .map(m => `<option value="${m.username}">${m.name}</option>`).join("");
                document.getElementById("tranBook").innerHTML = items
                    .filter(b => b.status === "available")
                    .map(b => `<option value="${b.name}">${b.name}</option>`).join("");
                document.getElementById("totalBooks").innerText = items.length;
                document.getElementById("totalMembers").innerText = members.length;
                document.getElementById("totalIssued").innerText = transactions.filter(t => t.status === "issued").length;
                document.getElementById("totalOverdue").innerText = transactions.filter(t => {
                    if (t.status === "issued") {
                        const diff = (new Date() - new Date(t.date)) / (1000 * 60 * 60 * 24);
                        return diff > 7;
                    }
                    return false;
                }).length;
                document.getElementById("profileUsername").value = currentUser.username;
                document.getElementById("profileName").value = currentUser.name || "";
            }
        </script>
    </div>
</body>
</html>


